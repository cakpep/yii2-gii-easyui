
String.prototype.addParam = function (params) {
    return this + (/\?/.test(this) ? '&' : '?') + $.param(params);
}

$('#dg-listview').datagrid({
    singleSelect: true,
    method: 'get',
    rownumbers: true,
    url: opts.dataUrl,
    pagination: true,
});

$('#btn-new').linkbutton({
    onClick: function () {
        opts.action = 'new';
        opts.row = undefined;
        $('#form').form('clear');
        $('#dialog').dialog('open');
    }
});
$('#btn-edit').linkbutton({
    onClick: function () {
        opts.row = $('#dg-listview').datagrid('getSelected');
        if (opts.row) {
            opts.action = 'edit';
            $('#form').form('load', opts.row);
            $('#dialog').dialog('open');
        }
    }
});
$('#btn-delete').linkbutton({
    onClick: function () {
        var row = $('#dg-listview').datagrid('getSelected');
        if (row) {
            $.messager.confirm('Confirm', 'Yakin akan menghapus ini?', function (r) {
                if (r) {
                    var url = opts.deleteUrl.addParam({id: row.id});
                    $.post(url, {}, function (data) {
                        if (data.type == 'error') {
                            $.messager.alert('Alert', data.message, 'alert');
                        } else {
                            $.messager.alert('Alert', data.message, 'alert');
                            $('#dg-listview').datagrid('reload');
                        }
                    });
                }
            });
        }
    }
});
// search
$('#inp-search').keypress(function (e) {
    if (e.which == 13) { // jika enter
        $('#dg-listview').datagrid('reload', {
            q: $('#inp-search').val(),
        });
    }
});

$('#form').form({
    iframe: false,
    success: function (data) {
        var data = JSON.parse(data);
        if (data.type == 'error') {
            $.messager.alert('Alert', data.message, 'alert');
        } else {
            $.messager.alert('Alert', data.message, 'alert');
            $('#dg-listview').datagrid('reload');
        }
        opts.row = undefined;
        $('#dialog').dialog('close');
    }
});
$('#dialog').dialog({
    buttons: [{
            text: 'Save',
            iconCls: 'icon-save',
            handler: function () {
                var url = opts.saveUrl;
                if (opts.action == 'edit') {
                    url = url.addParam({id: opts.row.id})
                }
                $('#form').form('submit', {
                    url: url,
                });

            }
        }, {
            text: 'Cancel',
            iconCls: 'icon-cancel',
            handler: function () {
                $('#dialog').dialog('close');
            }
        }]
});